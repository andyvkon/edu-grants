<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Community Aid Map 2026</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />

    <style>
      :root {
        --glass: rgba(15, 18, 28, 0.8);
        --glass-strong: rgba(10, 12, 20, 0.95);
        --glass-border: rgba(255, 255, 255, 0.08);
        --accent: #4f8cff;
        --accent-glow: rgba(79, 140, 255, 0.4);
        --text: #ffffff;
        --muted: #a0a0b0;
        --bg-dark: #050508;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        background: var(--bg-dark);
        font-family:
          "Inter",
          -apple-system,
          sans-serif;
        color: var(--text);
        overflow: hidden;
      }

      #map {
        height: 100vh;
        width: 100%;
        filter: grayscale(0.2) contrast(1.1);
      }

      /* SIDEBAR & MOBILE DRAWER */
      .sidebar {
        position: absolute;
        top: 15px;
        right: 15px;
        bottom: 15px;
        width: 340px;
        background: var(--glass);
        backdrop-filter: blur(25px) saturate(180%);
        border: 1px solid var(--glass-border);
        border-radius: 28px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        animation: slideIn 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        transition: transform 0.5s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          top: auto;
          right: 0;
          left: 0;
          bottom: 0;
          width: 100%;
          height: 50vh;
          border-radius: 28px 28px 0 0;
          transform: translateY(0);
        }
        .sidebar::before {
          content: "";
          width: 40px;
          height: 4px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 2px;
          margin: 10px auto;
          display: block;
        }
      }

      .header-section {
        padding: 24px;
      }

      /* LANG SWITCHER */
      .lang-switcher {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .lang-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 6px 10px;
        cursor: pointer;
        color: var(--muted);
        font-size: 13px;
        font-weight: 600;
        transition: 0.3s;
      }
      .lang-btn.active {
        color: #fff;
        border-color: var(--accent);
        background: rgba(79, 140, 255, 0.2);
      }

      /* SKELETON */
      .skeleton-wrapper {
        padding: 0 20px;
      }
      .skeleton {
        height: 50px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.03) 25%,
          rgba(255, 255, 255, 0.08) 50%,
          rgba(255, 255, 255, 0.03) 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 16px;
        margin-bottom: 10px;
      }
      @keyframes loading {
        from {
          background-position: 200% 0;
        }
        to {
          background-position: -200% 0;
        }
      }

      /* INPUTS */
      .search-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      input,
      select {
        width: 100%;
        padding: 14px 18px;
        border-radius: 16px;
        border: 1px solid var(--glass-border);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
        font-size: 14px;
        outline: none;
        transition: 0.3s;
      }
      input:focus,
      select:focus {
        border-color: var(--accent);
        background: rgba(79, 140, 255, 0.05);
        box-shadow: 0 0 15px var(--accent-glow);
      }
      select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 24 24'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 20px;
      }
      select option {
        background: #1a1f2e;
        color: #fff;
      }

      /* NAV */
      nav {
        flex: 1;
        overflow-y: auto;
        padding: 10px 15px;
      }
      nav button {
        width: 100%;
        margin-bottom: 8px;
        padding: 14px;
        border-radius: 18px;
        border: 1px solid transparent;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: 0.4s;
      }
      nav button svg {
        width: 22px;
        height: 22px;
        margin-right: 14px;
        fill: var(--muted);
      }
      nav button.active {
        background: rgba(79, 140, 255, 0.12);
        border-color: rgba(79, 140, 255, 0.2);
        color: var(--accent);
      }
      nav button.active svg {
        fill: var(--accent);
        filter: drop-shadow(0 0 5px var(--accent));
      }

      /* DETAIL CARD */
      .detail-card {
        position: absolute;
        right: 370px;
        top: 15px;
        width: 340px;
        background: var(--glass-strong);
        backdrop-filter: blur(30px);
        border: 1px solid var(--glass-border);
        border-radius: 28px;
        z-index: 1001;
        padding: 28px;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        pointer-events: none;
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      .detail-card.active {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      /* MARKERS */
      .apple-marker {
        width: 48px !important;
        height: 48px !important;
        border-radius: 50% !important;
        background: linear-gradient(145deg, #4f8cff, #1a5fff);
        display: flex !important;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        border: 2.5px solid #fff;
      }
      .apple-marker svg {
        width: 22px;
        height: 22px;
        fill: white;
      }
      .marker-cluster div {
        background: rgba(79, 140, 255, 0.9);
        color: white;
        font-weight: 800;
        border-radius: 50%;
      }

      /* ZOOM CONTROLS */
      .custom-zoom {
        position: absolute;
        bottom: 30px;
        left: 30px;
        z-index: 1000;
        display: flex;
        gap: 12px;
      }
      .map-btn {
        width: 50px;
        height: 50px;
        background: var(--glass);
        border: 1px solid var(--glass-border);
        color: white;
        border-radius: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
      }

      .county-zone {
        animation: pulseZone 3s infinite ease-in-out;
      }
      @keyframes pulseZone {
        0% {
          fill-opacity: 0.1;
        }
        50% {
          fill-opacity: 0.2;
        }
        100% {
          fill-opacity: 0.1;
        }
      }
    </style>
  </head>
  <body>
    <div class="custom-zoom">
      <button class="map-btn" onclick="map.zoomIn()">+</button>
      <button class="map-btn" onclick="map.zoomOut()">-</button>
      <button class="map-btn" onclick="locateUser()">üì°</button>
    </div>

    <div class="sidebar">
      <div class="header-section">
        <div class="lang-switcher">
          <button id="btn-en" class="lang-btn active" onclick="setLang('en')">
            üá∫üá∏ EN
          </button>
          <button id="btn-ru" class="lang-btn" onclick="setLang('ru')">
            üá∑üá∫ RU
          </button>
          <button id="btn-es" class="lang-btn" onclick="setLang('es')">
            üá™üá∏ ES
          </button>
        </div>
        <h2 id="ui-title">Help Hub 2026</h2>
        <div class="search-section">
          <input
            id="nameSearch"
            placeholder="Type name..."
            oninput="render()"
          />
          <select id="countySelect" onchange="changeCounty(this.value)">
            <option value="cook">Cook County, IL</option>
            <option value="lake">Lake County, IL</option>
            <option value="ny">Manhattan, NY (Test)</option>
          </select>
          <input
            id="zipSearch"
            placeholder="Zip code..."
            maxlength="5"
            oninput="render()"
          />
        </div>
      </div>

      <div id="loader" class="skeleton-wrapper">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>

      <nav id="categoryNav" style="display: none">
        <button data-type="all" class="active" onclick="filterCat(this)">
          <svg viewBox="0 0 24 24">
            <path d="M4 13h16v-2H4v2zm0 4h16v-2H4v2zm0-8h16V7H4v2z" />
          </svg>
          <span class="cat-label" data-key="all">All Resources</span>
        </button>
        <button data-type="food" onclick="filterCat(this)">
          <svg viewBox="0 0 24 24">
            <path
              d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"
            />
          </svg>
          <span class="cat-label" data-key="food">Food & WIC</span>
        </button>
        <button data-type="shelter" onclick="filterCat(this)">
          <svg viewBox="0 0 24 24">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
          </svg>
          <span class="cat-label" data-key="shelter">Shelter</span>
        </button>
        <button data-type="legal" onclick="filterCat(this)">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 3v1h5v2h-1.07c-.45 4.45-3.11 7.4-5.93 7.4-2.82 0-5.48-2.95-5.93-7.4H4V4h5V3h3zm0 16H3v2h18v-2h-9z"
            />
          </svg>
          <span class="cat-label" data-key="legal">Legal Aid</span>
        </button>
      </nav>

      <div
        id="stats"
        style="
          display: none;
          padding: 20px;
          border-top: 1px solid var(--glass-border);
        "
      >
        <span id="ui-found">Identified</span>:
        <span id="count" style="color: var(--accent)">0</span>
      </div>
    </div>

    <div id="map"></div>
    <div class="detail-card" id="detailCard"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
      const TRANSLATIONS = {
        en: {
          title: "Help Hub 2026",
          found: "Identified",
          all: "All Resources",
          food: "Food & WIC",
          shelter: "Shelter",
          legal: "Legal Aid",
          directions: "GET DIRECTIONS",
        },
        ru: {
          title: "–¶–µ–Ω—Ç—Ä –ø–æ–º–æ—â–∏ 2026",
          found: "–ù–∞–π–¥–µ–Ω–æ",
          all: "–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã",
          food: "–ï–¥–∞ –∏ WIC",
          shelter: "–ü—Ä–∏—é—Ç—ã",
          legal: "–Æ—Ä. –ø–æ–º–æ—â—å",
          directions: "–ú–ê–†–®–†–£–¢",
        },
        es: {
          title: "Centro de Ayuda",
          found: "Identificado",
          all: "Recursos",
          food: "Comida y WIC",
          shelter: "Refugio",
          legal: "Ayuda Legal",
          directions: "DIRECCIONES",
        },
      };

      const ICONS = {
        food: `<svg viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>`,
        shelter: `<svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>`,
        legal: `<svg viewBox="0 0 24 24"><path d="M12 3v1h5v2h-1.07c-.45 4.45-3.11 7.4-5.93 7.4-2.82 0-5.48-2.95-5.93-7.4H4V4h5V3h3zm0 16H3v2h18v-2h-9z"/></svg>`,
      };

      const COUNTIES = {
        cook: { center: [41.8781, -87.6298], zoom: 11 },
        lake: { center: [42.32, -87.95], zoom: 11 },
        ny: { center: [40.7128, -74.006], zoom: 13 },
      };

      let DATA = [],
        currentLang = "en",
        countyZone = null;
      const map = L.map("map", { zoomControl: false }).setView(
        COUNTIES.cook.center,
        11,
      );
      L.tileLayer(
        "https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png?api_key=0fe6180c-ac8c-4bb7-b57d-c83f1706f2ef",
      ).addTo(map);
      const clusters = L.markerClusterGroup().addTo(map);

      async function loadData() {
        try {
          const res = await fetch("/v2/grants/");
          DATA = await res.json();
          setTimeout(() => {
            document.getElementById("loader").style.display = "none";
            document.getElementById("categoryNav").style.display = "block";
            document.getElementById("stats").style.display = "block";
            render();
          }, 1000);
        } catch (e) {
          console.error(e);
        }
      }

      function setLang(lang) {
        currentLang = lang;
        document
          .querySelectorAll(".lang-btn")
          .forEach((b) => b.classList.toggle("active", b.id === `btn-${lang}`));
        const t = TRANSLATIONS[lang];
        document.getElementById("ui-title").innerText = t.title;
        document.getElementById("ui-found").innerText = t.found;
        document
          .querySelectorAll(".cat-label")
          .forEach((el) => (el.innerText = t[el.dataset.key]));
        render();
      }

      function changeCounty(key) {
        const c = COUNTIES[key];
        map.flyTo(c.center, c.zoom, { duration: 1.5 });
        if (countyZone) map.removeLayer(countyZone);
        countyZone = L.circle(c.center, {
          radius: 18000,
          color: "#4f8cff",
          weight: 2,
          fillOpacity: 0.1,
          className: "county-zone",
        }).addTo(map);
        setTimeout(render, 500);
      }

      function filterCat(btn) {
        document
          .querySelectorAll("nav button")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        render();
      }

      function render() {
        clusters.clearLayers();
        const type = document.querySelector("nav button.active").dataset.type;
        const nameQ = document.getElementById("nameSearch").value.toLowerCase();
        const zipQ = document.getElementById("zipSearch").value;

        const filtered = DATA.filter((r) => {
          const rCat = r.category?.toLowerCase() || "";
          const matchType =
            type === "all" ||
            rCat === type ||
            (type === "food" && rCat === "wic");
          const matchName = r.title.toLowerCase().includes(nameQ);
          const matchZip = !zipQ || (r.address && r.address.includes(zipQ));
          return matchType && matchName && matchZip;
        });

        document.getElementById("count").innerText = filtered.length;
        filtered.forEach((r) => {
          if (r.lat && r.lng) {
            let iconKey = (r.category || "food").toLowerCase();
            if (iconKey === "wic") iconKey = "food";
            const m = L.marker([r.lat, r.lng], {
              icon: L.divIcon({
                className: "apple-marker",
                html: ICONS[iconKey] || ICONS.food,
                iconSize: [48, 48],
                iconAnchor: [24, 24],
              }),
            }).on("click", (e) => {
              L.DomEvent.stopPropagation(e);
              showDetail(r);
            });
            clusters.addLayer(m);
          }
        });
      }

      function showDetail(r) {
        const card = document.getElementById("detailCard");
        card.classList.add("active");
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:15px">
             <span style="color:#4caf50; font-weight:700">‚óè ACTIVE</span>
             <button onclick="this.closest('.detail-card').classList.remove('active')" style="background:none; border:none; color:white; cursor:pointer; font-size:20px">√ó</button>
          </div>
          <h2>${r.title}</h2>
          <p style="color:var(--muted); line-height:1.5">${r.summary || ""}</p>
          <div style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:12px">üìç ${r.address || "Verified"}</div>
          <button class="map-btn" style="width:100%; margin-top:20px; font-size:14px; font-weight:700; background:var(--accent)" 
                  onclick="window.open('https://www.google.com/maps?q=${r.lat},${r.lng}')">
            ${TRANSLATIONS[currentLang].directions}
          </button>
        `;
      }

      function locateUser() {
        map.locate({ setView: true, maxZoom: 14 });
      }
      map.on("click", () =>
        document.getElementById("detailCard").classList.remove("active"),
      );
      window.onload = loadData;
    </script>
  </body>
</html>
