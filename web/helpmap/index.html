<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>–ö–∞—Ä—Ç–∞ –ø–æ–º–æ—â–∏ ‚Äî Cook County</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root { --brand:#0c8; --muted:#666; }
    *{ box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#222;}
    header { padding:10px 12px; border-bottom:1px solid #eee; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    header > * { font-size:14px; }
    #brand { font-weight:700; font-size:16px; margin-right:4px;}
    #map { height: calc(100vh - 120px); width: 100%; }
    .panel { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="text"], select { padding: 8px; border:1px solid #ddd; border-radius:8px; min-width: 150px;}
    button { padding: 8px 12px; border:1px solid var(--brand); border-radius:8px; background:var(--brand); color:#fff; cursor:pointer; }
    button.secondary { background:#fff; color:var(--brand); }
    .chip { padding: 4px 8px; border:1px solid #ddd; border-radius:999px; display:inline-flex; align-items:center; gap:6px; background:#fafafa; }
    .count { font-weight:600; }
    .lang { display:flex; gap:6px; align-items:center; }
    .legend { display:flex; gap:8px; flex-wrap:wrap; padding:8px 12px; border-bottom:1px solid #eee; }
    .legend .item { display:flex; gap:6px; align-items:center; color:#333; font-size:13px; }
    .legend .dot { font-size:18px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:auto; }
    .note { color:var(--muted); font-size:12px; }
    .toggles { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .linkbar { padding:6px 12px; display:flex; gap:10px; flex-wrap:wrap; border-bottom:1px solid #eee; background:#fcfcfc; }
    .linkbar a { color:#0066cc; text-decoration:none; font-size:13px; }
    .linkbar a:hover { text-decoration:underline; }
    @media (max-width:640px){
      #map{ height: calc(100vh - 160px); }
      header{ gap:6px; }
    }
  </style>
</head>
<body>
<header>
  <strong id="brand">–ü–æ–º–æ—â—å —Ä—è–¥–æ–º ‚Äî Cook County</strong>

  <div class="panel">
    <input id="q" type="text" placeholder="–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å/–∏–Ω–¥–µ–∫—Å/–Ω–∞–∑–≤–∞–Ω–∏–µ"/>
    <input id="zip" type="text" placeholder="–ò–Ω–¥–µ–∫—Å (ZIP)"/>
    <select id="type">
      <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
      <option value="food_bank">–ï–¥–∞ (Food bank)</option>
      <option value="shelter">–ü—Ä–∏—é—Ç/–Ω–æ—á–ª–µ–≥</option>
      <option value="infant_nutrition">–ü–∏—Ç–∞–Ω–∏–µ –¥–ª—è –º–ª–∞–¥–µ–Ω—Ü–µ–≤ (WIC)</option>
      <option value="free_clothes">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –æ–¥–µ–∂–¥–∞</option>
      <option value="addiction_recovery">–õ–µ—á–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π</option>
      <option value="idhs">IDHS –æ—Ñ–∏—Å</option>
    </select>
    <span class="chip">
      <label for="radius_km" id="radiusLabel">–†–∞–¥–∏—É—Å</label>
      <select id="radius_km">
        <option value="10">10–∫–º</option>
        <option value="25" selected>25–∫–º</option>
        <option value="50">50–∫–º</option>
      </select>
    </span>
    <div class="toggles">
      <label class="chip"><input id="useApi" type="checkbox" checked> <span id="useApiLabel">API</span></label>
      <label class="chip"><input id="useOffline" type="checkbox" checked> <span id="useOfflineLabel">–û—Ñ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã–µ Cook</span></label>
    </div>
    <button id="nearMe">–†—è–¥–æ–º</button>
    <button id="searchBtn">–ù–∞–π—Ç–∏</button>
    <span id="count" class="count">0</span>
  </div>

  <div class="toolbar">
    <div class="lang">
      <span class="note" id="langLabel">–Ø–∑—ã–∫:</span>
      <button class="secondary" data-lang="ru">RU</button>
      <button class="secondary" data-lang="uk">UA</button>
      <button class="secondary" data-lang="en">EN</button>
      <button class="secondary" data-lang="es">ES</button>
    </div>
  </div>
</header>

<div class="legend">
  <div class="item"><span class="dot">üçé</span><span id="lg_food">–ï–¥–∞</span></div>
  <div class="item"><span class="dot">üõèÔ∏è</span><span id="lg_shelter">–ü—Ä–∏—é—Ç</span></div>
  <div class="item"><span class="dot">üçº</span><span id="lg_infant">WIC/–¥–µ—Ç–∏</span></div>
  <div class="item"><span class="dot">üß•</span><span id="lg_clothes">–û–¥–µ–∂–¥–∞</span></div>
  <div class="item"><span class="dot">ü§ù</span><span id="lg_addiction">–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</span></div>
  <div class="item"><span class="dot">üèõÔ∏è</span><span id="lg_idhs">IDHS</span></div>
</div>

<div class="linkbar">
  <a href="https://abe.illinois.gov/abe/access/" target="_blank" rel="noopener">–ü–æ–¥–∞—Ç—å –Ω–∞ SNAP/WIC/Medicaid –≤ ABE</a>
  <a href="https://www.dhs.state.il.us/page.aspx?module=12&officetype=5" target="_blank" rel="noopener">IDHS –æ—Ñ–∏—Å—ã (–ø–æ–∏—Å–∫)</a>
  <a href="tel:1833234634357">IDHS: 1-833-2-FIND-HELP</a>
  <span class="note" id="tipsNote">–°–æ–≤–µ—Ç: –∫–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Äî —á–∞—Å—ã/—Å–∞–π—Ç/—Ç–µ–ª–µ—Ñ–æ–Ω</span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º—É–ª—å—Ç–∏—è–∑—ã—á–∏—è ===
  const i18n = {
    ru: {
      brand: "–ü–æ–º–æ—â—å —Ä—è–¥–æ–º ‚Äî Cook County",
      searchPlaceholder: "–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å/–∏–Ω–¥–µ–∫—Å/–Ω–∞–∑–≤–∞–Ω–∏–µ",
      zipPlaceholder: "–ò–Ω–¥–µ–∫—Å (ZIP)",
      radius: "–†–∞–¥–∏—É—Å",
      btnNear: "–†—è–¥–æ–º",
      btnFind: "–ù–∞–π—Ç–∏",
      api: "API",
      offline: "–û—Ñ—Ñ–ª–∞–π–Ω-–¥–∞–Ω–Ω—ã–µ Cook",
      tips: "–°–æ–≤–µ—Ç: –∫–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Äî —á–∞—Å—ã/—Å–∞–π—Ç/—Ç–µ–ª–µ—Ñ–æ–Ω",
      legend: {food:"–ï–¥–∞", shelter:"–ü—Ä–∏—é—Ç", infant:"WIC/–¥–µ—Ç–∏", clothes:"–û–¥–µ–∂–¥–∞", addiction:"–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏", idhs:"IDHS"},
      types: {
        food_bank: "–ü—É–Ω–∫—Ç –µ–¥—ã",
        shelter: "–ü—Ä–∏—é—Ç/–Ω–æ—á–ª–µ–≥",
        infant_nutrition: "WIC/–¥–µ—Ç—Å–∫–æ–µ –ø–∏—Ç–∞–Ω–∏–µ",
        free_clothes: "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –æ–¥–µ–∂–¥–∞",
        addiction_recovery: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π",
        idhs: "IDHS –æ—Ñ–∏—Å"
      },
      helpText: {
        food_bank: "–í–æ–∑—å–º–∏—Ç–µ ID (–µ—Å–ª–∏ –µ—Å—Ç—å). –í —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç –∏ –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.",
        shelter: "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏–π—Ç–∏ —Ä–∞–Ω–æ –≤–µ—á–µ—Ä–æ–º. –£–∑–Ω–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –Ω–∞–ª–∏—á–∏–µ –º–µ—Å—Ç.",
        infant_nutrition: "WIC: –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã/–¥–æ—Ö–æ–¥.",
        free_clothes: "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Å—ã –ø—Ä–∏—ë–º–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–π/–≤—ã–¥–∞—á–∏.",
        addiction_recovery: "–ü–æ–∑–≤–æ–Ω–∏—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ –¥–ª—è intake. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ/—Å–∫–æ–ª—å–∑—è—â–∞—è —à–∫–∞–ª–∞.",
        idhs: "–ß–µ—Ä–µ–∑ ABE –º–æ–∂–Ω–æ –ø–æ–¥–∞—Ç—å –Ω–∞ SNAP/WIC/Medicaid. –ù–∞ –º–µ—Å—Ç–µ ‚Äî –ø–æ–º–æ—â—å —Å –∞–Ω–∫–µ—Ç–∞–º–∏."
      }
    },
    uk: {
      brand:"–î–æ–ø–æ–º–æ–≥–∞ –ø–æ—Ä—É—á ‚Äî –æ–∫—Ä—É–≥ –ö—É–∫",
      searchPlaceholder:"–ü–æ—à—É–∫ –∞–¥—Ä–µ—Å–∞/—ñ–Ω–¥–µ–∫—Å/–Ω–∞–∑–≤–∞",
      zipPlaceholder:"–Ü–Ω–¥–µ–∫—Å (ZIP)",
      radius:"–†–∞–¥—ñ—É—Å",
      btnNear:"–ü–æ—Ä—É—á",
      btnFind:"–ó–Ω–∞–π—Ç–∏",
      api:"API",
      offline:"–û—Ñ–ª–∞–π–Ω-–¥–∞–Ω—ñ Cook",
      tips:"–ü–æ—Ä–∞–¥–∞: –∫–ª—ñ–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É ‚Äî –≥–æ–¥–∏–Ω–∏/—Å–∞–π—Ç/—Ç–µ–ª–µ—Ñ–æ–Ω",
      legend:{food:"–á–∂–∞", shelter:"–ü—Ä–∏—Ç—É–ª–æ–∫", infant:"WIC/–¥—ñ—Ç–∏", clothes:"–û–¥—è–≥", addiction:"–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ", idhs:"IDHS"},
      types:{food_bank:"–ü—É–Ω–∫—Ç —ó–∂—ñ", shelter:"–ü—Ä–∏—Ç—É–ª–æ–∫", infant_nutrition:"WIC/–¥–∏—Ç—è—á–µ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è", free_clothes:"–ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –æ–¥—è–≥", addiction_recovery:"–î–æ–ø–æ–º–æ–≥–∞ –≤—ñ–¥ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π", idhs:"IDHS –æ—Ñ—ñ—Å"},
      helpText:{food_bank:"–í—ñ–∑—å–º—ñ—Ç—å ID (–∑–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ). –í –µ–∫—Å—Ç—Ä–µ–Ω–∏—Ö –≤–∏–ø–∞–¥–∫–∞—Ö –¥–æ–ø–æ–º–æ–∂—É—Ç—å –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤.", shelter:"–ö—Ä–∞—â–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç–∏ –≤–≤–µ—á–µ—Ä—ñ —Ä–∞–Ω—ñ—à–µ. –î—ñ–∑–Ω–∞–π—Ç–µ—Å—å –ø—Ä–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –º—ñ—Å—Ü—å.", infant_nutrition:"WIC: –∑–∞–ø–∏—à—ñ—Ç—å—Å—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏/–¥–æ—Ö—ñ–¥.", free_clothes:"–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≥–æ–¥–∏–Ω–∏ –ø—Ä–∏–π–æ–º—É/–≤–∏–¥–∞—á—ñ.", addiction_recovery:"–ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–π—Ç–µ –¥–ª—è –ø–µ—Ä–≤–∏–Ω–Ω–æ–≥–æ –ø—Ä–∏–π–æ–º—É.", idhs:"–ü–æ–¥–∞–π—Ç–µ –Ω–∞ SNAP/WIC/Medicaid —á–µ—Ä–µ–∑ ABE."}
    },
    en: {
      brand:"Help Nearby ‚Äî Cook County",
      searchPlaceholder:"Search address/zip/name",
      zipPlaceholder:"ZIP code",
      radius:"Radius",
      btnNear:"Near me",
      btnFind:"Search",
      api:"API",
      offline:"Offline Cook data",
      tips:"Tip: click marker for hours/site/phone",
      legend:{food:"Food", shelter:"Shelter", infant:"WIC/Infant", clothes:"Clothes", addiction:"Addiction", idhs:"IDHS"},
      types:{food_bank:"Food Bank", shelter:"Shelter", infant_nutrition:"Infant nutrition (WIC)", free_clothes:"Free clothing", addiction_recovery:"Addiction recovery", idhs:"IDHS office"},
      helpText:{food_bank:"Bring ID if available. In emergencies, service may be provided without docs.", shelter:"Arrive early evening. Ask about bed availability and rules.", infant_nutrition:"WIC: call to schedule; check documents/income.", free_clothes:"Check donation/distribution hours.", addiction_recovery:"Call ahead for intake. Many are free or sliding-scale.", idhs:"Apply for SNAP/WIC/Medicaid via ABE; in-person help available."}
    },
    es: {
      brand:"Ayuda Cerca ‚Äî Condado de Cook",
      searchPlaceholder:"Buscar direcci√≥n/c√≥digo/nombre",
      zipPlaceholder:"C√≥digo ZIP",
      radius:"Radio",
      btnNear:"Cerca",
      btnFind:"Buscar",
      api:"API",
      offline:"Datos locales (Cook)",
      tips:"Consejo: clic en marcador para horario/sitio/tel√©fono",
      legend:{food:"Comida", shelter:"Refugio", infant:"WIC/Infantes", clothes:"Ropa", addiction:"Adicciones", idhs:"IDHS"},
      types:{food_bank:"Banco de alimentos", shelter:"Refugio", infant_nutrition:"Nutrici√≥n infantil (WIC)", free_clothes:"Ropa gratis", addiction_recovery:"Tratamiento adicciones", idhs:"Oficina IDHS"},
      helpText:{food_bank:"Trae ID si tienes. En emergencias atienden sin documentos.", shelter:"Llega temprano por la tarde. Consulta camas y reglas.", infant_nutrition:"WIC: llama para cita; revisa documentos/ingresos.", free_clothes:"Revisa horarios de entrega.", addiction_recovery:"Llama antes para admisi√≥n (intake).", idhs:"Solicita SNAP/WIC/Medicaid en ABE; ayuda en persona disponible."}
    }
  };
  let LANG = localStorage.getItem("HELP_LANG") || "ru";

  function applyLang() {
    const t = i18n[LANG];
    document.getElementById("brand").innerText = t.brand;
    document.getElementById("q").placeholder = t.searchPlaceholder;
    document.getElementById("zip").placeholder = t.zipPlaceholder;
    document.getElementById("radiusLabel").innerText = t.radius;
    document.getElementById("nearMe").innerText = t.btnNear;
    document.getElementById("searchBtn").innerText = t.btnFind;
    document.getElementById("useApiLabel").innerText = t.api;
    document.getElementById("useOfflineLabel").innerText = t.offline;
    document.getElementById("tipsNote").innerText = t.tips;
    document.getElementById("lg_food").innerText = t.legend.food;
    document.getElementById("lg_shelter").innerText = t.legend.shelter;
    document.getElementById("lg_infant").innerText = t.legend.infant;
    document.getElementById("lg_clothes").innerText = t.legend.clothes;
    document.getElementById("lg_addiction").innerText = t.legend.addiction;
    document.getElementById("lg_idhs").innerText = t.legend.idhs;
  }
  document.querySelectorAll('[data-lang]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      LANG = btn.dataset.lang; localStorage.setItem("HELP_LANG", LANG); applyLang();
      runSearch(true);
    });
  });
  applyLang();

  // === –ö–∞—Ä—Ç–∞ –∏ –∏–∫–æ–Ω–∫–∏ ===
  const API_BASE = localStorage.getItem("API_BASE") || "http://localhost:8000";
  const map = L.map('map').setView([41.881832, -87.623177], 12);
 const darkMatter = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
  {
    attribution: '&copy; OpenStreetMap contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }
).addTo(map);

  const clusters = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius: 60 });
  map.addLayer(clusters);

  function iconFor(type) {
    const emoji = { food_bank:"üçé", shelter:"üõèÔ∏è", infant_nutrition:"üçº", free_clothes:"üß•", addiction_recovery:"ü§ù", idhs:"üèõÔ∏è" }[type] || "üìç";
    return L.divIcon({ className:"marker", html:`<div style="font-size:22px">${emoji}</div>`, iconSize:[22,22], iconAnchor:[11,22], popupAnchor:[0,-22] });
  }

  // === –û—Ñ–ª–∞–π–Ω-–Ω–∞–±–æ—Ä –ø–æ Cook County (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã) ===
  // –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π —Å–º. –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞.
  const OFFLINE_COOK = [
    // --- FOOD BANKS / PANTRIES ---
    { id:"gcfdb", type:"food_bank", name:"Greater Chicago Food Depository (HQ & referrals)", latitude:41.81736, longitude:-87.72711, address:"4100 W Ann Lurie Pl", city:"Chicago", state:"IL", zip_code:"60632", phone:"773-247-3663", website:"https://www.chicagosfoodbank.org", hours:"Mon‚ÄìFri 8:30‚Äì17:00", languages:["EN","ES"], description:"–ò–Ω—Ñ–æ/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ –±–ª–∏–∂–∞–π—à–∏–º pantry." },
    { id:"nh_sheridan", type:"food_bank", name:"Nourishing Hope ‚Äî Sheridan Market", latitude:41.9539, longitude:-87.6540, address:"3945 N Sheridan Rd", city:"Chicago", state:"IL", zip_code:"60613", phone:"773-525-1777", website:"https://www.nourishinghopechi.org/get-food/sheridan-market/", hours:"—Å–º. —Å–∞–π—Ç", languages:["EN","ES"], description:"–ü–∏—â–µ–≤–æ–π —Ä—ã–Ω–æ–∫/—Å–æ—Ü.—É—Å–ª—É–≥–∏." },

    // --- SHELTERS / OVERNIGHT ---
    { id:"pgm", type:"shelter", name:"Pacific Garden Mission (24/7)", latitude:41.861999, longitude:-87.640233, address:"1458 S Canal St", city:"Chicago", state:"IL", zip_code:"60607", phone:"312-492-9410", website:"https://www.pgm.org/", hours:"–ö—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ", languages:["EN","ES"], description:"–ü—Ä–∏—é—Ç, –ø–∏—Ç–∞–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–º—å—è–º, –º—É–∂—á–∏–Ω–∞–º –∏ –∂–µ–Ω—â–∏–Ω–∞–º." },
    { id:"booth", type:"shelter", name:"Salvation Army ‚Äî Evangeline Booth Lodge (—Å–µ–º—å–∏)", latitude:41.96926, longitude:-87.65042, address:"800 W Lawrence Ave", city:"Chicago", state:"IL", zip_code:"60640", phone:"773-275-9383", website:"https://centralusa.salvationarmy.org/northcentralillinois/evangeline-booth-lodge/", hours:"24/7", languages:["EN","ES"], description:"–ö—Ä–∏–∑–∏—Å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å–µ–º–µ–π." },
    { id:"garfield_center", type:"shelter", name:"DFSS Garfield Community Service Center (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –ø—Ä–∏—é—Ç–æ–≤)", latitude:41.88095, longitude:-87.70552, address:"10 S Kedzie Ave", city:"Chicago", state:"IL", zip_code:"60612", phone:"312-746-5400", website:"https://www.chicago.gov/.../community_servicecenterlocations.html", hours:"Mon‚ÄìFri 9‚Äì17", languages:["EN","ES"], description:"–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞/–∫—É–ª–µ—Ä, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–∏—é—Ç—ã." },

    // --- WIC / INFANT NUTRITION ---
    { id:"wic_ceda_lawrence", type:"infant_nutrition", name:"CEDA WIC ‚Äî Lawrence", latitude:41.9690, longitude:-87.7010, address:"2754 W Lawrence Ave", city:"Chicago", state:"IL", zip_code:"60625", phone:"773-878-0578", website:"https://www.cedaorg.net", hours:"Mon‚ÄìFri 8‚Äì16:30", languages:["EN","ES"], description:"WIC –¥–ª—è –±–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö/–¥–µ—Ç–µ–π." },

    // --- FREE CLOTHES / CHILDREN ---
    { id:"c2c", type:"free_clothes", name:"Cradles to Crayons ‚Äî Giving Factory (—á–µ—Ä–µ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤)", latitude:41.9467, longitude:-87.6924, address:"2500 W Bradley Pl", city:"Chicago", state:"IL", zip_code:"60618", phone:"", website:"https://www.cradlestocrayons.org/chicago/new-giving-factory/", hours:"—Å–º. —Å–∞–π—Ç", languages:["EN"], description:"–û–¥–µ–∂–¥–∞/—Ç–æ–≤–∞—Ä—ã –¥–ª—è –¥–µ—Ç–µ–π —á–µ—Ä–µ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏." },

    // --- ADDICTION RECOVERY (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–µ —á–µ—Ä–µ–∑ –∞–¥—Ä–µ—Å) ---
    { id:"night_ministry", type:"addiction_recovery", name:"The Night Ministry ‚Äî Health Outreach (–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è)", latitude:41.9139, longitude:-87.6683, address:"1735 N Ashland Ave, Suite 2000", city:"Chicago", state:"IL", zip_code:"60622", phone:"773-784-9000", website:"https://www.thenightministry.org/contact-tnm", hours:"—Å–º. —Å–∞–π—Ç", languages:["EN","ES"], description:"–ú–æ–±–∏–ª—å–Ω–∞—è –ø–æ–º–æ—â—å/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ –ª–µ—á–µ–Ω–∏—é, youth shelter The Crib." },

    // --- IDHS OFFICES (FCRC) ---
    { id:"idhs_southloop", type:"idhs", name:"IDHS FCRC ‚Äî South Loop", latitude:41.8676, longitude:-87.6258, address:"1112 S Wabash Ave", city:"Chicago", state:"IL", zip_code:"60605", phone:"312-793-7500", website:"https://www.dhs.state.il.us", hours:"—Å–º. —Å–∞–π—Ç", languages:["EN","ES"], description:"SNAP/WIC/Medicaid ‚Äî –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ ABE." },
    { id:"idhs_northside", type:"idhs", name:"IDHS FCRC ‚Äî Northside", latitude:41.99386, longitude:-87.75026, address:"6200 N Hiawatha Ave (5 —ç—Ç–∞–∂)", city:"Chicago", state:"IL", zip_code:"60646", phone:"773-907-4100", website:"https://www.dhs.state.il.us", hours:"—Å–º. —Å–∞–π—Ç", languages:["EN","ES"], description:"–û–±—â–∏–π –ø—Ä–∏—ë–º, –ø–æ–¥–¥–µ—Ä–∂–∫–∞." },
    { id:"idhs_northwest", type:"idhs", name:"IDHS FCRC ‚Äî Northwest", latitude:41.89524, longitude:-87.72875, address:"4105 W Chicago Ave", city:"Chicago", state:"IL", zip_code:"60651", phone:"773-265-7000", website:"https://www.dhs.state.il.us", hours:"—Å–º. —Å–∞–π—Ç", languages:["EN","ES"], description:"–û–±—â–∏–π –ø—Ä–∏—ë–º, –ø–æ–¥–¥–µ—Ä–∂–∫–∞." },
    { id:"idhs_woodlawn", type:"idhs", name:"IDHS FCRC ‚Äî Woodlawn", latitude:41.7807, longitude:-87.6036, address:"915 E 63rd St", city:"Chicago", state:"IL", zip_code:"60637", phone:"773-753-2406", website:"https://www.dhs.state.il.us", hours:"—Å–º. —Å–∞–π—Ç", languages:["EN","ES"], description:"–û–±—â–∏–π –ø—Ä–∏—ë–º, –ø–æ–¥–¥–µ—Ä–∂–∫–∞." }
  ];

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ API ===
  async function fetchFromApi(params={}) {
    const url = new URL(API_BASE + "/resources");
    Object.entries(params).forEach(([k,v]) => {
      if (v !== undefined && v !== null && v !== "" && v !== "all") url.searchParams.set(k, v);
    });
    const res = await fetch(url.toString());
    if (!res.ok) throw new Error("API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");
    return res.json();
  }

  function popupHtml(r) {
    const t = i18n[LANG];
    const typeLabel = t.types[r.type] || r.type;
    const langs = (r.languages || []).join(", ");
    const help = t.helpText[r.type] || "";
    return `
      <strong>${r.name}</strong><br/>
      <em>${typeLabel}</em><br/>
      ${r.address || ""}${r.city?`, ${r.city}`:""}${r.state?`, ${r.state}`:""} ${r.zip_code || ""}<br/>
      ${r.phone ? `‚òéÔ∏è <a href="tel:${r.phone.replace(/[^0-9+]/g,'')}">${r.phone}</a><br/>` : "" }
      ${r.website ? `<a href="${r.website}" target="_blank" rel="noopener">üåê Website</a><br/>` : "" }
      ${r.hours ? `‚è∞ ${r.hours}<br/>` : "" }
      ${r.description ? `<small>${r.description}</small><br/>` : "" }
      ${langs ? `üåê ${langs}<br/>` : ""}
      ${help ? `<div class="note">${help}</div>` : ""}
    `;
  }

  function renderResources(items) {
    clusters.clearLayers();
    items.forEach(r => {
      if (typeof r.latitude !== "number" || typeof r.longitude !== "number") return;
      const m = L.marker([r.latitude, r.longitude], { icon: iconFor(r.type) });
      m.bindPopup(popupHtml(r));
      clusters.addLayer(m);
    });
    if (items.length) {
      const bounds = L.latLngBounds(items.filter(r=>r.latitude && r.longitude).map(r => [r.latitude, r.longitude]));
      if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
    }
    document.getElementById("count").textContent = items.length;
  }

  async function runSearch(useCenter=false) {
    const params = {};
    const typeVal = document.getElementById("type").value;
    const q = document.getElementById("q").value.trim();
    const zip = document.getElementById("zip").value.trim();
    const radius = document.getElementById("radius_km").value;
    const useApi = document.getElementById("useApi").checked;
    const useOffline = document.getElementById("useOffline").checked;

    if (typeVal !== "all") params.type = typeVal;
    if (q) params.q = q;
    if (zip) params.zip_code = zip;

    if (useCenter) {
      const c = map.getCenter();
      params.lat = c.lat.toFixed(6);
      params.lng = c.lng.toFixed(6);
      params.radius_km = radius;
    }

    let items = [];
    if (useApi) {
      try { items = await fetchFromApi(params); } catch(e) { console.warn("API error:", e); }
    }
    if (useOffline) {
      const filtered = OFFLINE_COOK.filter(r => {
        const typeOk = (typeVal === "all") || (r.type === typeVal);
        const qOk = q ? ( (r.name||"").toLowerCase().includes(q.toLowerCase()) || (r.address||"").toLowerCase().includes(q.toLowerCase()) ) : true;
        const zipOk = zip ? (r.zip_code === zip) : true;
        return typeOk && qOk && zipOk;
      });
      // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ä–∞–¥–∏—É—Å –ø–æ —Ü–µ–Ω—Ç—Ä—É –∫–∞—Ä—Ç—ã
      if (useCenter) {
        const c = map.getCenter();
        const R = Number(radius) || 25;
        items = items.concat(filtered.filter(r => {
          const d = haversineKm(c.lat, c.lng, r.latitude, r.longitude);
          return d <= R;
        }));
      } else {
        items = items.concat(filtered);
      }
    }
    // —É–±—Ä–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ id/name+addr
    const uniq = {};
    const merged = [];
    for (const r of items) {
      const key = r.id || `${r.name}|${r.address}`;
      if (!uniq[key]) { uniq[key]=1; merged.push(r); }
    }
    renderResources(merged);
  }

  // –≥–µ–æ-—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
  function haversineKm(lat1, lon1, lat2, lon2) {
    const toRad = x => x*Math.PI/180;
    const R = 6371;
    const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  document.getElementById("searchBtn").addEventListener("click", () => runSearch(true));
  document.getElementById("nearMe").addEventListener("click", () => {
    if (!navigator.geolocation) return runSearch(true);
    navigator.geolocation.getCurrentPosition(
      pos => { map.setView([pos.coords.latitude, pos.coords.longitude], 12); runSearch(true); },
      () => runSearch(true)
    );
  });

  // –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
  runSearch(true);
</script>
</body>
</html>
